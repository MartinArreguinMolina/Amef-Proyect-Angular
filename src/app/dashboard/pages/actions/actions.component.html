<div class="min-h-dvh bg-gradient-to-b from-white to-slate-50 text-slate-800" data-theme="light">
  <div class="h-1 bg-gradient-to-r from-[#153e75] via-black to-[#153e75]"></div>

  <app-header [action]="true"/>

  <div class="mx-auto max-w-screen-2xl px-4 sm:px-6 lg:px-8 xl:px-10 py-6 grid grid-cols-12 gap-6">
    <aside class="col-span-12 md:col-span-4 xl:col-span-3">
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="p-3.5 sm:p-4 border-b border-slate-200 space-y-3">
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
              <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-4.35-4.35M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" />
            </svg>
            <input #q class="input input-sm input-bordered w-full pl-9 pr-2 bg-white text-slate-900 placeholder:text-slate-500 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20" placeholder="Buscar por texto o responsable…" (input)="setSearch(q.value)" />
          </div>
        </div>

        <div class="max-h-[66dvh] sm:max-h-[70dvh] lg:max-h-[72dvh] overflow-auto">
          <div class="p-4 animate-pulse space-y-2" [class.hidden]="actionsRes.status() !== 'loading'">
            <div class="h-3 bg-slate-100 rounded"></div>
            <div class="h-3 bg-slate-100 rounded w-2/3"></div>
            <div class="h-3 bg-slate-100 rounded"></div>
          </div>

          @for (a of listFiltered(); track a.id) {
          <button
            class="relative w-full text-left p-3.5 sm:p-4 transition flex items-start gap-3 border-b border-slate-100 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-[#153e75]/20"
            [ngClass]="selected() === a.id ? 'bg-gradient-to-r from-[#f5f9ff] to-white border-l-4 border-[#153e75] shadow-[0_8px_20px_-8px_rgba(21,62,117,0.25)]' : ''"
            (click)="select(a.id)">
            <div class="mt-1">
              <div class="w-2.5 h-2.5 rounded-full" [ngClass]="{
                     'bg-emerald-500' : (a.newSeverity && a.newOccurrence && a.newDetection) && (a.newSeverity*a.newOccurrence*a.newDetection) < 100,
                     'bg-amber-500'   : (a.newSeverity && a.newOccurrence && a.newDetection) && (a.newSeverity*a.newOccurrence*a.newDetection) >= 100 && (a.newSeverity*a.newOccurrence*a.newDetection) < 200,
                     'bg-rose-500'    : (a.newSeverity && a.newOccurrence && a.newDetection) && (a.newSeverity*a.newOccurrence*a.newDetection) >= 200,
                     'bg-slate-300'   : !(a.newSeverity && a.newOccurrence && a.newDetection)
                   }"></div>
            </div>

            <div class="flex-1 min-w-0">
              <div class="font-medium truncate text-slate-900">{{ a.recommendedAction || '—' }}</div>
              <div class="text-xs text-slate-500 truncate">{{ a.responsible || 'Sin responsable' }}</div>
              <div class="mt-2 flex items-center gap-2 text-[11px]">
                <span class="text-slate-500">Target:</span>
                <span class="px-1.5 py-0.5 rounded border border-slate-200 bg-slate-50 text-slate-700">{{ a.targetDate || '—' }}</span>
              </div>
            </div>

            <div class="text-right shrink-0">
              <div class="text-[10px] tracking-wide uppercase text-slate-500">NPRʼ</div>
              <span class="badge mt-0.5 border {{ nprColor((a.newSeverity && a.newOccurrence && a.newDetection) ? (a.newSeverity*a.newOccurrence*a.newDetection) : null) }}">
                {{ (a.newSeverity && a.newOccurrence && a.newDetection) ? (a.newSeverity*a.newOccurrence*a.newDetection) : '—' }}
              </span>
            </div>
          </button>
          }

          <div class="p-6 text-slate-500" [class.hidden]="!(listFiltered().length === 0 && actionsRes.status() !== 'loading')">
            <div class=" border border-dashed border-slate-300 p-5 text-sm grid place-items-center">
              <div class="text-center">
                <div class="font-semibold text-slate-700">Sin acciones</div>
                <p class="mt-1">Crea una <b>nueva acción</b> o ajusta los filtros.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <main class="col-span-12 md:col-span-8 xl:col-span-6">
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="h-1 bg-[#153e75]"></div>

        <div class="p-5 sm:p-6 md:p-7 space-y-7" [formGroup]="form">
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <h3 class="text-base sm:text-lg font-bold text-slate-900 leading-tight truncate">Acción</h3>
              <p class="mt-0.5 text-[11px] sm:text-xs text-slate-500">Prioriza eliminar <b>modo</b> o <b>causa</b>; si no, mejora <b>prevención</b>/<b>detección</b>.</p>
            </div>
          </div>

          <section aria-labelledby="definicion" class="grid grid-cols-12 gap-4 sm:gap-6">
            <h4 id="definicion" class="col-span-12 text-[13px] font-semibold text-slate-700">Definición</h4>

            <label class="form-control flex flex-col gap-2 sm:gap-3 col-span-12">
              <span class="label-text text-[13px] font-medium text-slate-700">Acción recomendada</span>
              <div class="text-[11px] text-slate-500 -mt-1">Específica y verificable. Ej.: “Sustituir fijación por soldadura por puntos en subensamble X”.</div>
              <textarea autoResize rows="3" class="textarea textarea-bordered min-h-[96px]  bg-white text-slate-900 placeholder:text-slate-500 border-slate-300 leading-relaxed focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20" formControlName="recommendedAction" placeholder="Describe exactamente qué harás…"></textarea>
              <forms-error-label [control]="form.get('recommendedAction')!" />
            </label>

            <label class="form-control flex flex-col gap-2 sm:gap-3 col-span-12 md:col-span-6">
              <span class="label-text text-[13px] font-medium text-slate-700">Responsable</span>
              <div class="text-[11px] text-slate-500 -mt-1">Persona que ejecuta/coordina (no “equipo”).</div>

              <div class="relative">
                <input (input)="onResponsibleInput(search.value)" class="input input-bordered w-full  bg-white text-slate-900 placeholder:text-slate-500 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20" formControlName="responsibleText" placeholder="Nombre completo" #search aria-haspopup="listbox" aria-expanded="{{ this.users.hasValue() && this.users.value()!.length > 0 }}" />

                @if (this.users.hasValue() && this.users.value()!.length > 0) {
                <div class="absolute left-0 right-0 mt-1 z-30">
                  <ul class="rounded-2xl bg-white/95 backdrop-blur border border-slate-200 shadow-2xl ring-1 ring-black/5 overflow-hidden" role="listbox" aria-label="Sugerencias de responsables">
                    <li class="px-3 py-2 text-[11px] font-semibold tracking-wide uppercase text-slate-500 bg-slate-50 border-b border-slate-200">
                      Sugerencias ({{ this.users.value()!.length }})
                    </li>
                    <li class="max-h-60 overflow-y-auto">
                      <ul class="p-1">
                        @for (user of this.users.value(); track $index) {
                        <li class="my-0.5">
                          <button type="button" role="option" (click)="onSelectUser(user)" class="w-full flex items-center gap-3 px-3 py-2  text-left transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-[#153e75]/30 active:scale-[.99]" title="{{ user.fullName }}">
                            <div class="min-w-0 flex-1">
                              <div class="font-medium truncate text-slate-900">{{ user.fullName | titlecase }}</div>
                              <div class="text-[11px] text-slate-500 truncate">{{ user.email || 'Seleccionar como responsable' }}</div>
                            </div>
                          </button>
                        </li>
                        }
                      </ul>
                    </li>
                  </ul>
                </div>
                }
              </div>

              @if (responsibleError()) {
              <div class="mt-1 text-[11px] text-rose-700 bg-rose-50/70 border border-rose-200 rounded-md px-2 py-1.5 inline-flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 8h.01M12 12v4"></path>
                </svg>
                Selecciona un responsable de la lista.
              </div>
              }

              <div class="flex flex-wrap gap-2 pt-1">
                <button type="button" (click)="clearDepartmentFilter()" class="btn btn-xs text-white bg-[#153e75] hover:bg-black ">Limpiar filtros</button>

                @if(users.error()){
                <span class="text-[12px] text-rose-600">Error al cargar usuarios.</span>
                }

                @for (department of departaments.value(); track $index) {
                <button type="button" (click)="changeDepartment(department.department)" class="btn btn-xs border-slate-300" [ngClass]="{
                    'bg-[#153e75] text-white hover:bg-[#0f2e58] border-[#153e75]': department.department === this.department(),
                    'btn-outline text-slate-700 hover:bg-slate-100': department.department !== this.department()
                  }">
                  {{ department.department }}
                </button>
                }
              </div>
            </label>

            <label class="form-control flex flex-col gap-2 sm:gap-3 col-span-12 md:col-span-6">
              <span class="label-text text-[13px] font-medium text-slate-700">Fecha target</span>
              <div class="text-[11px] text-slate-500 -mt-1">Compromiso de cierre.</div>
              <input type="date" class="input input-bordered  bg-white text-slate-900 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20" formControlName="targetDate" />
              <forms-error-label [control]="form.get('targetDate')!" />
            </label>
          </section>

          <section aria-labelledby="cierre" class="grid grid-cols-12 gap-4 sm:gap-6">
            <h4 id="cierre" class="col-span-12 text-[13px] font-semibold text-slate-700">Cierre</h4>

            <label class="form-control flex flex-col gap-2 sm:gap-3 col-span-12">
              <span class="label-text text-[13px] font-medium text-slate-700">Acción implementada</span>
              <div class="text-[11px] text-slate-500 -mt-1">Método, materiales, lote, versión. Este campo + <b>Fecha de cierre</b> recalculan NPR’.</div>
              <textarea autoResize rows="3" class="textarea textarea-bordered min-h-[96px]  bg-white text-slate-900 placeholder:text-slate-500 border-slate-300 leading-relaxed focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20" formControlName="implementedAction" placeholder="Describe exactamente lo realizado…"></textarea>
              <forms-error-label [control]="form.get('implementedAction')!" />
            </label>

            <label class="form-control flex flex-col gap-2 sm:gap-3 col-span-12 md:col-span-6">
              <span class="label-text text-[13px] font-medium text-slate-700">Fecha de cierre</span>
              <div class="text-[11px] text-slate-500 -mt-1">Debe ser ≥ fecha target.</div>
              <input type="date" class="input input-bordered  bg-white text-slate-900 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20" formControlName="completionDate" />
              <span class="text-xs text-slate-500">No debe ser anterior a la fecha target.</span>
              <forms-error-label [control]="form.get('completionDate')!" />
            </label>
          </section>

          <section aria-labelledby="npr" class="grid grid-cols-12 gap-4 sm:gap-6">
            <h4 id="npr" class="col-span-12 text-[13px] font-semibold text-slate-700">NPR’</h4>

            <label class="form-control flex flex-col gap-1.5 sm:gap-2 col-span-12 sm:col-span-4">
              <span class="label-text text-[13px] font-medium text-slate-700">Severidad (S’ 1–10)</span>
              <input type="number" min="1" max="10" class="input input-bordered  text-center font-mono bg-white text-slate-900 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20" formControlName="newSeverity" />
              <forms-error-label [control]="form.get('newSeverity')!" />
            </label>

            <label class="form-control flex flex-col gap-1.5 sm:gap-2 col-span-12 sm:col-span-4">
              <span class="label-text text-[13px] font-medium text-slate-700">Ocurrencia (O’ 1–10)</span>
              <input type="number" min="1" max="10" class="input input-bordered  text-center font-mono bg-white text-slate-900 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20" formControlName="newOccurrence" />
              <forms-error-label [control]="form.get('newOccurrence')!" />
            </label>

            <label class="form-control flex flex-col gap-1.5 sm:gap-2 col-span-12 sm:col-span-4">
              <span class="label-text text-[13px] font-medium text-slate-700">Detección (D’ 1–10)</span>
              <input type="number" min="1" max="10" class="input input-bordered  text-center font-mono bg-white text-slate-900 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20" formControlName="newDetection" />
              <forms-error-label [control]="form.get('newDetection')!" />
            </label>
          </section>
        </div>
      </div>
    </main>

    <aside class="col-span-12 xl:col-span-3">
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="p-6 space-y-5" [formGroup]="form">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-xs uppercase tracking-wide text-slate-500">NPR</div>
              <div class="mt-1 text-[11px] text-slate-500">Base: {{ nprBefore() ?? '—' }}</div>
              <div class="mt-3">
                <span class="inline-flex items-center justify-center w-16 h-16 rounded-full border-2" [ngClass]="{
                    'border-red-300 bg-red-50 text-red-700'          : (nprEffective() ?? 0) >= 200,
                    'border-amber-300 bg-amber-50 text-amber-700'    : (nprEffective() ?? 0) >= 100 && (nprEffective() ?? 0) < 200,
                    'border-emerald-300 bg-emerald-50 text-emerald-700': (nprEffective() ?? 0) > 0 && (nprEffective() ?? 0) < 100,
                    'border-slate-200 bg-slate-50 text-slate-500'    : !(nprEffective())
                  }">
                  <span class="text-xl font-extrabold">{{ nprEffective() ?? '—' }}</span>
                </span>

                <div class="mt-1 flex items-center gap-2">
                  @if (nprAfter()) {
                  <span class="badge border border-emerald-200 bg-emerald-50 text-emerald-700">NPR’</span>
                  <span class="text-[11px] text-slate-600">S′×O′×D′ (valores nuevos).</span>
                  } @else {
                  <span class="badge border border-slate-200 bg-slate-50 text-slate-700">Base</span>
                  <span class="text-[11px] text-slate-600">NPR base del análisis.</span>
                  }
                </div>
              </div>
            </div>

            <div class="text-xs text-slate-500 max-w-[12rem]">
              @if (nprBefore() && nprAfter() && nprAfter()! >= nprBefore()!) {
              <div class="p-2 rounded bg-amber-50 text-amber-700 border border-amber-200">
                La acción no reduce el riesgo. Revisa si apunta a <b>modo</b> o <b>causa</b>.
              </div>
              }
            </div>
          </div>

          <div class="divider my-2"></div>

          <div class="grid gap-2">
            <button class="btn bg-[#153e75] hover:bg-black text-white " (click)="save()" [disabled]="saving()">Guardar</button>
            <button class="btn btn-outline border-slate-300 text-slate-800 " (click)="newAction()">Nueva</button>
            <button class="btn btn-outline border-red-200 bg-red-600 text-white " (click)="delete()" [disabled]="!form.value.id">Eliminar</button>
          </div>

          <div class="divider my-2"></div>

          <div id="actions-guide"></div>
          <div role="tablist" class="tabs tabs-lifted w-full">
            <input type="radio" name="actions-tabs" role="tab" class="tab text-slate-700 [--tab-bg:white] [--tab-border-color:#e2e8f0] data-[state=checked]:text-[#153e75]" aria-label="Flujo" checked />
            <div role="tabpanel" class="tab-content bg-white border border-slate-200 rounded-b-xl p-4 text-[12px] leading-5 space-y-3">
              <ol class="list-decimal ml-4 space-y-1 text-slate-700">
                <li>Primero elimina <b class="text-[#153e75]">modo</b> o <b class="text-[#153e75]">causa</b>.</li>
                <li>Si no es viable, mejora <b class="text-[#153e75]">prevención/detección</b> para bajar O′ o D′.</li>
                <li>Completa <b class="text-[#153e75]">Implementada</b> y <b class="text-[#153e75]">Fecha de cierre</b>.</li>
                <li>Valora <b class="text-[#153e75]">S′/O′/D′</b> con la misma escala y calcula <b class="text-[#153e75]">NPR’</b>.</li>
              </ol>
              <div class="text-[12px] text-slate-600 space-y-1">
                <div class="font-semibold text-slate-700">Reglas</div>
                <div>1) Elimina el modo de fallo si es posible.</div>
                <div>2) Si no, elimina la causa.</div>
                <div>3) Si no, mejora prevención/detección y reduce O’ o D’.</div>
                <div>4) Recalcula con la misma escala.</div>
              </div>
            </div>

            <input type="radio" name="actions-tabs" role="tab" class="tab text-slate-700 [--tab-bg:white] [--tab-border-color:#e2e8f0] data-[state=checked]:text-[#153e75]" aria-label="Escalas" />
            <div role="tabpanel" class="tab-content bg-white border border-slate-200 rounded-b-xl p-4">
              <div class="grid grid-cols-1 gap-2">
                <div class="p-2 rounded bg-slate-50 border border-[#153e75]/20">
                  <div class="font-semibold text-[#153e75] text-[12px]">Severidad S′</div>
                  <div class="mt-1 space-y-0.5 text-[12px] text-slate-700">
                    <div><b class="text-rose-700">9–10</b> peligro/norma</div>
                    <div><b class="text-amber-700">7–8</b> muy insatisfecho</div>
                    <div><b class="text-amber-600">5–6</b> degradación</div>
                    <div><b class="text-emerald-700">3–4</b> leve</div>
                    <div><b class="text-emerald-600">1–2</b> mínimo</div>
                  </div>
                </div>
                <div class="p-2 rounded bg-slate-50 border border-[#153e75]/20">
                  <div class="font-semibold text-[#153e75] text-[12px]">Ocurrencia O′</div>
                  <div class="mt-1 space-y-0.5 text-[12px] text-slate-700">
                    <div><b class="text-rose-700">9–10</b> casi inevitable</div>
                    <div><b class="text-amber-700">7–8</b> repetidos</div>
                    <div><b class="text-amber-600">5–6</b> ocasionales</div>
                    <div><b class="text-emerald-700">3–4</b> pocos</div>
                    <div><b class="text-emerald-600">1–2</b> remotos</div>
                  </div>
                </div>
                <div class="p-2 rounded bg-slate-50 border border-[#153e75]/20">
                  <div class="font-semibold text-[#153e75] text-[12px]">Detección D′</div>
                  <div class="mt-1 space-y-0.5 text-[12px] text-slate-700">
                    <div><b class="text-rose-700">9–10</b> sin método/no detecta</div>
                    <div><b class="text-amber-700">7–8</b> alta no-detección</div>
                    <div><b class="text-amber-600">5–6</b> moderada</div>
                    <div><b class="text-emerald-700">3–4</b> baja</div>
                    <div><b class="text-emerald-600">1–2</b> casi seguro</div>
                  </div>
                </div>
              </div>
            </div>

            <input type="radio" name="actions-tabs" role="tab" class="tab text-slate-700 [--tab-bg:white] [--tab-border-color:#e2e8f0] data-[state=checked]:text-[#153e75]" aria-label="Checklist" />
            <div role="tabpanel" class="tab-content bg-white border border-slate-200 rounded-b-xl p-4">
              <ul class="list-disc ml-4 space-y-1 text-[12px] text-slate-700">
                <li>Acción clara y verificable (qué/cómo/dónde/cuándo).</li>
                <li>Responsable y fecha target definidos.</li>
                <li>Si está hecha: Implementada + Fecha de cierre.</li>
                <li>S′/O′/D′ coherentes con la escala.</li>
                <li>NPR’ < NPR base o justificación.</li>
              </ul>
            </div>

            <input type="radio" name="actions-tabs" role="tab" class="tab text-slate-700 [--tab-bg:white] [--tab-border-color:#e2e8f0] data-[state=checked]:text-[#153e75]" aria-label="Ejemplo" />
            <div role="tabpanel" class="tab-content bg-white border border-slate-200 rounded-b-xl p-4">
              <div class="rounded-lg border border-[#153e75]/20 p-3 bg-slate-50 text-[12px]">
                <div class="font-semibold mb-1 text-[#153e75]">Ejemplo</div>
                <div><b class="text-slate-800">Recomendada:</b> Añadir poka-yoke de montaje del conector.</div>
                <div><b class="text-slate-800">Implementada:</b> Guía 3D impresa (v2, lote 24-10).</div>
                <div><b class="text-slate-800">S′/O′/D′:</b> 8 / 2 / 3 → <b class="text-[#153e75]">NPR’ 48</b> (desde 96).</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div class="fixed bottom-4 right-4 z-50" [class.hidden]="!toast()">
    <div class="flex items-center gap-3  px-4 py-3 text-white shadow-lg ring-1 ring-black/5 transition-all duration-300"
      [ngClass]="{
        'bg-emerald-600': toast()?.kind === 'success',
        'bg-sky-600':     toast()?.kind === 'update',
        'bg-rose-600':    toast()?.kind === 'delete',
        'bg-red-600':     toast()?.kind === 'error'
      }" role="status" aria-live="polite">
      @if (toast()?.kind !== 'delete' && toast()?.kind !== 'error') {
      <svg class="w-5 h-5 opacity-90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
      </svg>
      }
      @if (toast()?.kind === 'delete') {
      <svg class="w-5 h-5 opacity-90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
      }
      @if (toast()?.kind === 'error') {
      <svg class="w-5 h-5 opacity-90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
      </svg>
      }
      <span class="text-sm font-medium truncate max-w-[56ch]">{{ toast()?.text }}</span>
      <button type="button" class="ml-1 -mr-1 rounded-md/80 bg-white/10 hover:bg-white/20 px-1.5 py-1 text-xs" aria-label="Cerrar notificación" (click)="closeToast()">✕</button>
    </div>
  </div>
</div>
