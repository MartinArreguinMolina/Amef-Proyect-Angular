<div class="min-h-dvh bg-gradient-to-b from-white to-slate-50 text-slate-800" data-theme="light">
  <div class="h-1 bg-gradient-to-r from-[#153e75] via-black to-[#153e75]"></div>
  <app-header />
  <div class="mx-auto max-w-screen-2xl px-4 sm:px-6 lg:px-8 xl:px-10 py-6 grid grid-cols-12 gap-6">
    <aside class="col-span-12 md:col-span-4 xl:col-span-3">
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="p-3 sm:p-4 border-b border-slate-200 flex items-center gap-2">
          <div class="relative flex-1 min-w-0">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="1.8">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="m21 21-4.35-4.35M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" />
            </svg>
            <input #q
              class="input input-bordered w-full pl-9 pr-10 bg-white text-slate-900 placeholder:text-slate-500 placeholder:text-[12px] sm:placeholder:text-[13px] border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20"
              placeholder="Buscar (modo, función, efectos, causas)" [value]="search()" (input)="setSearch(q.value)" />
          </div>
        </div>

        <div class="max-h-[66dvh] sm:max-h-[70dvh] lg:max-h-[72dvh] overflow-auto">
          <div class="p-4 animate-pulse space-y-2" [class.hidden]="analysesRes.status() !== 'loading'">
            <div class="h-3 bg-slate-100 rounded"></div>
            <div class="h-3 bg-slate-100 rounded w-2/3"></div>
            <div class="h-3 bg-slate-100 rounded"></div>
          </div>

          @for (a of listFiltered(); track a.id) {
          <button
            class="relative w-full text-left p-3 sm:p-4 transition-all flex items-start gap-3 border-b border-slate-100 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-[#153e75]/20"
            [ngClass]="selected() === a.id ? 'bg-gradient-to-r from-[#f5f9ff] to-white border-l-4 border-[#153e75] shadow-[0_8px_20px_-8px_rgba(21,62,117,0.25)]' : ''"
            (click)="select(a.id)">
            <div class="flex-1 min-w-0">
              <div class="font-medium truncate text-slate-900">{{ a.failureMode }}
              </div>
              <div class="text-xs text-slate-500 truncate">{{ a.systemFunction }}</div>
              <div class="mt-1 flex items-center gap-2">
                <span
                  class="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-700">S
                  <b>{{ a.severity }}</b></span>
                <span
                  class="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-700">O
                  <b>{{ a.occurrence }}</b></span>
                <span
                  class="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-700">D
                  <b>{{ a.detection }}</b></span>
              </div>
            </div>
            <span class="badge border rounded-md {{ nprColor(a.npr) }}">{{ a.npr }}</span>
          </button>
          }
          <div class="p-6 text-slate-500"
            [class.hidden]="!(listFiltered().length === 0 && analysesRes.status() !== 'loading')">
            <div class="border border-dashed border-slate-300 p-5 text-sm text-center">
              Sin resultados. Crea un <b>nuevo análisis</b> o ajusta la búsqueda.
            </div>
          </div>
        </div>
      </div>
    </aside>

    <main class="col-span-12 md:col-span-5 xl:col-span-6">
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="h-1 bg-[#153e75]"></div>

        <div class="p-4 sm:p-6 space-y-6 sm:space-y-7" [formGroup]="form">
          <div class="flex items-center justify-between gap-3">
            <div>
              <h3 class="text-base sm:text-lg font-bold text-slate-900">Detalle del análisis</h3>
              <p class="text-[11px] sm:text-xs text-slate-500">Sigue la guía para describir bien efectos, causas y
                controles. S/O/D ajustan el NPR y la AP.</p>
            </div>
            <span
              class="text-[11px] sm:text-xs text-[#153e75] bg-[#153e75]/10 border border-[#153e75]/20 px-2 py-0.5 rounded-md font-semibold">ID:
              {{ form.value.id || 'nuevo' }}</span>
          </div>

          <div class="grid grid-cols-12 gap-4 sm:gap-6">
            <label class="form-control flex flex-col gap-2 sm:gap-3 col-span-12 md:col-span-6">
              <span class="label-text text-[13px] font-medium text-slate-700">Sistema / Función</span>
              <div class="text-[11px] text-slate-500 -mt-1">Qué debe hacer el sistema. <b class="text-[#153e75]">No</b>
                pongas la causa ni el
                efecto.</div>
              <input
                class="input input-bordered bg-white text-slate-900 placeholder:text-slate-500 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20"
                formControlName="systemFunction" placeholder="Frenos ABS" />
              <forms-error-label [control]="form.get('systemFunction')!" />
            </label>

            <label class="form-control flex flex-col gap-2 sm:gap-3 col-span-12 md:col-span-6">
              <span class="label-text text-[13px] font-medium text-slate-700">Modo de fallo</span>
              <div class="text-[11px] text-slate-500 -mt-1">Cómo falla la función. Evita causas/efectos.</div>
              <input
                class="input input-bordered bg-white text-slate-900 placeholder:text-slate-500 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20"
                formControlName="failureMode" placeholder="Pérdida de presión" />
              <forms-error-label [control]="form.get('failureMode')!" />
            </label>
          </div>

          <div class="grid grid-cols-12 gap-4 sm:gap-6">
            <label class="form-control flex flex-col gap-2 sm:gap-3 col-span-12 lg:col-span-6">
              <span class="label-text text-[13px] font-medium text-slate-700">Efectos</span>
              <textarea autoResize rows="5"
                class="textarea textarea-bordered min-h-[140px] bg-white text-slate-900 placeholder:text-slate-500 border-slate-300 leading-relaxed focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20"
                formControlName="failureEffects" placeholder="Impacto para cliente/seguridad/regulación…"></textarea>
              <forms-error-label [control]="form.get('failureEffects')!" />
            </label>

            <label class="form-control flex flex-col gap-2 sm:gap-3 col-span-12 lg:col-span-6">
              <span class="label-text text-[13px] font-medium text-slate-700">Causas</span>
              <textarea autoResize rows="5"
                class="textarea textarea-bordered min-h-[140px] bg-white text-slate-900 placeholder:text-slate-500 border-slate-300 leading-relaxed focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20"
                formControlName="failureCauses"
                placeholder="Causa raíz probable, variación del proceso, diseño, proveedor…"></textarea>
              <forms-error-label [control]="form.get('failureCauses')!" />
            </label>
          </div>

          <label class="form-control flex flex-col gap-2 sm:gap-3">
            <span class="label-text text-[13px] font-medium text-slate-700">Controles de prevención</span>
            <textarea autoResize rows="3"
              class="textarea textarea-bordered min-h-[110px] bg-white text-slate-900 placeholder:text-slate-500 border-slate-300 leading-relaxed focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20"
              formControlName="currentControls"
              placeholder="Inspección, pruebas, poka-yoke, validaciones, etc."></textarea>
            <forms-error-label [control]="form.get('currentControls')!" />
          </label>

          <div class="grid grid-cols-12 gap-4 sm:gap-6">
            <label class="form-control flex flex-col gap-1.5 sm:gap-2 col-span-12 sm:col-span-4">
              <div class="flex items-center justify-between">
                <span class="label-text text-[13px] font-medium text-slate-700">Severidad (1–10)</span>
                <span class="px-2 py-0.5 rounded bg-slate-100 text-slate-700 text-xs font-semibold">{{
                  form.value.severity ?? '—' }}</span>
              </div>
              <input type="number" min="1" max="10"
                class="input input-bordered text-center font-mono bg-white text-slate-900 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20"
                formControlName="severity" />
              <forms-error-label [control]="form.get('severity')!" />
            </label>

            <label class="form-control flex flex-col gap-1.5 sm:gap-2 col-span-12 sm:col-span-4">
              <div class="flex items-center justify-between">
                <span class="label-text text-[13px] font-medium text-slate-700">Ocurrencia (1–10)</span>
                <span class="px-2 py-0.5 rounded bg-slate-100 text-slate-700 text-xs font-semibold">{{
                  form.value.occurrence ?? '—' }}</span>
              </div>
              <input type="number" min="1" max="10"
                class="input input-bordered text-center font-mono bg-white text-slate-900 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20"
                formControlName="occurrence" />
              <forms-error-label [control]="form.get('occurrence')!" />
            </label>

            <label class="form-control flex flex-col gap-1.5 sm:gap-2 col-span-12 sm:col-span-4">
              <div class="flex items-center justify-between">
                <span class="label-text text-[13px] font-medium text-slate-700">Detección (1–10)</span>
                <span class="px-2 py-0.5 rounded bg-slate-100 text-slate-700 text-xs font-semibold">{{
                  form.value.detection ?? '—' }}</span>
              </div>
              <input type="number" min="1" max="10"
                class="input input-bordered text-center font-mono bg-white text-slate-900 border-slate-300 focus:border-[#153e75] focus:ring-2 focus:ring-[#153e75]/20"
                formControlName="detection" />
              <forms-error-label [control]="form.get('detection')!" />
            </label>
          </div>
        </div>
      </div>
    </main>

    <aside class="col-span-12 md:col-span-3 xl:col-span-3">
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="p-5 sm:p-6 space-y-5" [formGroup]="form">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-xs uppercase tracking-wide text-slate-500">AP — Prioridad de acción</div>
              <div class="mt-2 flex items-center gap-2">
                <span class="inline-flex items-center justify-center h-7 px-3 rounded-full border text-sm font-bold"
                  [ngClass]="apClass(ap)">{{ ap ?? '—' }}</span>
                <span class="text-xs text-slate-500" [class.hidden]="!ap">({{ apText(ap) }})</span>
              </div>
            </div>
            <div class="text-right">
              <div class="text-[10px] uppercase text-slate-500">NPR</div>
              <div class="mt-1">
                <span class="inline-flex items-center justify-center w-12 h-12 rounded-full border" [ngClass]="{
                    'border-red-300 bg-red-50 text-red-700': (form.value.npr ?? 0) >= 200,
                    'border-amber-300 bg-amber-50 text-amber-700': (form.value.npr ?? 0) >= 100 && (form.value.npr ?? 0) < 200,
                    'border-emerald-300 bg-emerald-50 text-emerald-700': (form.value.npr ?? 0) > 0 && (form.value.npr ?? 0) < 100,
                    'border-slate-200 bg-slate-50 text-slate-500': !(form.value.npr)
                  }">
                  <span class="text-sm font-extrabold">{{ form.value.npr ?? '—' }}</span>
                </span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2">
            <div class="text-center">
              <div class="text-[10px] text-slate-500 mb-0.5">S</div>
              <div class="px-2 py-1 rounded bg-slate-100 text-slate-700 text-xs font-semibold">{{ form.value.severity ??
                '—' }}</div>
            </div>
            <div class="text-center">
              <div class="text-[10px] text-slate-500 mb-0.5">O</div>
              <div class="px-2 py-1 rounded bg-slate-100 text-slate-700 text-xs font-semibold">{{ form.value.occurrence
                ?? '—' }}</div>
            </div>
            <div class="text-center">
              <div class="text-[10px] text-slate-500 mb-0.5">D</div>
              <div class="px-2 py-1 rounded bg-slate-100 text-slate-700 text-xs font-semibold">{{ form.value.detection
                ?? '—' }}</div>
            </div>
          </div>

          <div class="divider my-1"></div>

          <div class="flex flex-col gap-2">
            <button class="btn btn-md bg-[#153e75] text-white" (click)="save()" [disabled]="saving()">Guardar</button>
            <button class="btn btn-md btn-outline border-slate-300 text-slate-800"
              (click)="newAnalysis()">Nuevo</button>
            <button class="btn btn-md bg-red-600 text-white" (click)="delete()"
              [disabled]="!form.value.id">Eliminar</button>
          </div>

          <div class="divider my-1"></div>

          <div role="tablist" class="tabs tabs-lifted w-full">
            <input type="radio" name="guide-tabs" role="tab"
              class="tab text-slate-700 [--tab-bg:white] [--tab-border-color:#e2e8f0] data-[state=checked]:text-[#153e75]"
              aria-label="Flujo" checked />
            <div role="tabpanel"
              class="tab-content bg-white border border-slate-200 rounded-b-xl p-4 text-[12px] leading-5 space-y-2">
              <div class="font-semibold text-slate-700">Flujo</div>
              <ol class="list-decimal ml-4 space-y-1 text-slate-700">
                <li>Define <b class="text-[#153e75]">Sistema/Función</b> → <b class="text-[#153e75]">Modo de fallo</b>.
                </li>
                <li>Describe <b class="text-[#153e75]">Efectos</b> y valora <b class="text-[#153e75]">S</b>.</li>
                <li>Identifica <b class="text-[#153e75]">Causas</b> y valora <b class="text-[#153e75]">O</b>.</li>
                <li>Lista <b class="text-[#153e75]">Controles</b> y valora <b class="text-[#153e75]">D</b>.</li>
                <li>Calcula <b class="text-[#153e75]">NPR = S×O×D</b> y revisa <b class="text-[#153e75]">AP</b>.</li>
              </ol>
            </div>

            <input type="radio" name="guide-tabs" role="tab"
              class="tab text-slate-700 [--tab-bg:white] [--tab-border-color:#e2e8f0] data-[state=checked]:text-[#153e75]"
              aria-label="Escalas" />
            <div role="tabpanel" class="tab-content bg-white border border-slate-200 rounded-b-xl p-4">
              <div class="grid grid-cols-1 gap-2">
                <div class="p-2 rounded bg-slate-50 border border-[#153e75]/20">
                  <div class="font-semibold text-[#153e75] text-[12px]">Severidad</div>
                  <ul class="mt-1 space-y-0.5 text-[12px] text-slate-700">
                    <li><b class="text-rose-700">9–10</b> Peligro/incumple normas</li>
                    <li><b class="text-amber-700">7–8</b> Muy insatisfecho</li>
                    <li><b class="text-amber-600">5–6</b> Degradación</li>
                    <li><b class="text-emerald-700">3–4</b> Leve</li>
                    <li><b class="text-emerald-600">1–2</b> Mínimo</li>
                  </ul>
                </div>
                <div class="p-2 rounded bg-slate-50 border border-[#153e75]/20">
                  <div class="font-semibold text-[#153e75] text-[12px]">Ocurrencia</div>
                  <ul class="mt-1 space-y-0.5 text-[12px] text-slate-700">
                    <li><b class="text-rose-700">9–10</b> Inevitable</li>
                    <li><b class="text-amber-700">7–8</b> Repetidos</li>
                    <li><b class="text-amber-600">5–6</b> Ocasionales</li>
                    <li><b class="text-emerald-700">3–4</b> Pocos</li>
                    <li><b class="text-emerald-600">1–2</b> Remotos</li>
                  </ul>
                </div>
                <div class="p-2 rounded bg-slate-50 border border-[#153e75]/20">
                  <div class="font-semibold text-[#153e75] text-[12px]">Detección</div>
                  <ul class="mt-1 space-y-0.5 text-[12px] text-slate-700">
                    <li><b class="text-rose-700">9–10</b> No detecta</li>
                    <li><b class="text-amber-700">7–8</b> Alta prob. no detectar</li>
                    <li><b class="text-amber-600">5–6</b> Moderada</li>
                    <li><b class="text-emerald-700">3–4</b> Baja</li>
                    <li><b class="text-emerald-600">1–2</b> Casi seguro</li>
                  </ul>
                </div>
              </div>
            </div>

            <input type="radio" name="guide-tabs" role="tab"
              class="tab text-slate-700 [--tab-bg:white] [--tab-border-color:#e2e8f0] data-[state=checked]:text-[#153e75]"
              aria-label="Checklist" />
            <div role="tabpanel" class="tab-content bg-white border border-slate-200 rounded-b-xl p-4">
              <ul class="list-disc ml-4 space-y-1 text-[12px] text-slate-700">
                <li>Modo ≠ causa ≠ efecto.</li>
                <li>Efectos: cliente/seguridad/regulación.</li>
                <li>Causas específicas, evita genéricos.</li>
                <li>Controles: prevención o detección.</li>
                <li>Valores S/O/D dentro de 1–10.</li>
              </ul>
            </div>

            <input type="radio" name="guide-tabs" role="tab"
              class="tab text-slate-700 [--tab-bg:white] [--tab-border-color:#e2e8f0] data-[state=checked]:text-[#153e75]"
              aria-label="Ejemplo" />
            <div role="tabpanel" class="tab-content bg-white border border-slate-200 rounded-b-xl p-4">
              <div class="rounded-lg border border-[#153e75]/20 p-3 bg-slate-50 text-[12px]">
                <div class="font-semibold mb-1 text-[#153e75]">Ejemplo (frenos ABS)</div>
                <div><b class="text-slate-800">Función:</b> Mantener control de frenado.</div>
                <div><b class="text-slate-800">Modo:</b> Pérdida de presión hidráulica.</div>
                <div><b class="text-slate-800">Efecto:</b> Aumento de distancia de frenado.</div>
                <div><b class="text-slate-800">Causas:</b> Fuga sello bomba / burbujas en circuito.</div>
                <div><b class="text-slate-800">Controles:</b> Prueba de estanqueidad 100% / purga automatizada.</div>
                <div class="mt-1"><b class="text-[#153e75]">S/O/D:</b> 8 / 4 / 3 → <b class="text-[#153e75]">NPR 96</b>
                  • <b class="text-amber-700">AP</b> media.</div>
              </div>
            </div>
          </div>

          @if(form.value.id){
          <div>
            <button [routerLink]="[form.value.id, 'actions']" class="btn bg-[#153e75] w-full text-white">Acciones
              correctivas</button>
            <p class="mt-2 text-[11px] text-slate-500">Añade responsables y recalcula el NPR/AP con S/O/D nuevos.</p>
          </div>
          }

          <div>
            @if(form.value.id){
            <button [routerLink]="[this.form.value.id, 'comments']" class="btn bg-[#153e75] text-white w-full">
              <svg aria-label="WeChat logo" width="16" height="16" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 32 32">
                <g fill="white">
                  <path
                    d="M11.606,3.068C5.031,3.068,0,7.529,0,12.393s4.344,7.681,4.344,7.681l-.706,2.676c-.093,.353,.284,.644,.602,.464l3.173-1.798c1.403,.447,4.381,.59,4.671,.603-.208-.721-.311-1.432-.311-2.095,0-3.754,3.268-9.04,10.532-9.04,.165,0,.331,.004,.496,.011-.965-4.627-5.769-7.827-11.195-7.827Zm-4.327,7.748c-.797,0-1.442-.646-1.442-1.442s.646-1.442,1.442-1.442,1.442,.646,1.442,1.442-.646,1.442-1.442,1.442Zm8.386,0c-.797,0-1.442-.646-1.442-1.442s.646-1.442,1.442-1.442,1.442,.646,1.442,1.442-.646,1.442-1.442,1.442Z">
                  </path>
                  <path
                    d="M32,19.336c0-4.26-4.998-7.379-9.694-7.379-6.642,0-9.459,4.797-9.459,7.966s2.818,7.966,9.459,7.966c1.469,0,2.762-.211,3.886-.584l2.498,1.585c.197,.125,.447-.052,.394-.279l-.567-2.46c2.36-1.643,3.483-4.234,3.483-6.815Zm-12.73-.81c-.704,0-1.275-.571-1.275-1.275s.571-1.275,1.275-1.275,1.275,.571,1.275,1.275c0,.705-.571,1.275-1.275,1.275Zm6.373,0c-.704,0-1.275-.571-1.275-1.275s.571-1.275,1.275-1.275,1.275,.571,1.275,1.275-.571,1.275-1.275,1.275Z">
                  </path>
                </g>
              </svg>
              Comentarios

              @if(numberNewComments()){
              <div class="badge badge-sm badge-secondary">{{numberNewComments()}}</div>
              }

            </button>
            }
            <p class="mt-2 text-[11px] text-slate-500">Añade comentarios para tu equipo</p>
          </div>

        </div>
      </div>
    </aside>
  </div>

  <div class="fixed bottom-4 right-4 z-50" [class.hidden]="!toast()">
    <div class="flex items-center gap-3 px-4 py-3 text-white shadow-lg ring-1 ring-black/5 transition-all duration-300"
      [ngClass]="{
        'bg-emerald-600': toast()?.kind === 'success',
        'bg-sky-600': toast()?.kind === 'update',
        'bg-rose-600': toast()?.kind === 'delete',
        'bg-red-600': toast()?.kind === 'error'
      }" role="status" aria-live="polite">
      <svg class="w-5 h-5 opacity-90" [class.hidden]="toast()?.kind === 'delete' || toast()?.kind === 'error'"
        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
      </svg>
      <svg class="w-5 h-5 opacity-90" [class.hidden]="toast()?.kind !== 'delete'" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
      <svg class="w-5 h-5 opacity-90" [class.hidden]="toast()?.kind !== 'error'" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
      </svg>
      <span class="text-sm font-medium truncate max-w-[56ch]">{{ toast()?.text }}</span>
      <button type="button" class="ml-1 -mr-1 rounded-md/80 bg-white/10 hover:bg-white/20 px-1.5 py-1 text-xs"
        aria-label="Cerrar notificación" (click)="closeToast()">✕</button>
    </div>
  </div>

  <div class="fixed top-4 right-4 z-[60] transition-opacity duration-300 pointer-events-none"
    [class.opacity-0]="!sendCommentSucces()" [class.opacity-100]="sendCommentSucces()" aria-live="polite">
    <div class="rounded-lg bg-[#153e75] text-white/95 shadow-lg ring-1 ring-black/5 px-3 py-2 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 shrink-0" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
      </svg>
      <span class="text-xs font-medium tracking-wide">Mensaje enviado</span>
    </div>
  </div>
</div>
